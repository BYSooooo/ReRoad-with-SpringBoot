<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml"
      xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout">
<th:block layout:fragment="css">

</th:block>
<th:block layout:fragment="script">
    <script th:src="@{/js/jquery-3.6.0.min.js}"></script>
    <script th:src="@{/js/jquery-ui.min.js}"></script>
</th:block>
<head>
<script>
    function registration() {
        let username = $('#username').val();
        const chaturl = 'http://localhost:8080';
        let chatstompClient;
        let chatselectedUser;
        let chatnewMessage = new Map();

        $.ajax({
            url: chaturl + "/registration/" + username,
            success: function (response) {
                console.log(`response : ${response}`);
                $.get(chaturl + "/fetchAllUsers", function (response) {
                        let users = response;
                        let usersTemplateHTML = "";
                        for (let i = 0; i < users.length; i++) {
                            usersTemplateHTML = usersTemplateHTML + '<a href="/join/with?username='+users[i]+'" ><li class="clearfix">\n' +
                                '                <img src="https://rtfm.co.ua/wp-content/plugins/all-in-one-seo-pack/images/default-user-image.png" width="55px" height="55px" alt="avatar" />\n' +
                                '                <div class="about">\n' +
                                '                    <div id="userNameAppender_' + users[i] + '" class="name" >' + users[i] + '</div>\n' +
                                '                    <div class="status">\n' +
                                '                        <i class="fa fa-circle offline"></i>\n' +
                                '                    </div>\n' +
                                '                </div>\n' +
                                '            </li></a>';
                        }
                        $('#usersList').html(usersTemplateHTML);
                        $('#startChat').attr('disabled','disabled');

                    });
                }

            ,
            error: function (ex) {
                console.log(`ex : ${ex}`);
                if (ex.status === 400) {
                    alert("Login is already busy!")
                }
            }
        });
    }

    function fetchAll() {
        const chaturl = 'http://localhost:8080';
        let chatstompClient;
        let chatselectedUser;
        let chatnewMessage = new Map();

        $.get(chaturl + "/fetchAllUsers", function (response) {
            let users = response;
            let usersTemplateHTML = "";
            for (let i = 0; i < users.length; i++) {
                usersTemplateHTML = usersTemplateHTML + '<a href="/join/with?username='+users[i]+'"><li class="clearfix">\n' +
                    '                <img src="https://rtfm.co.ua/wp-content/plugins/all-in-one-seo-pack/images/default-user-image.png" width="55px" height="55px" alt="avatar" />\n' +
                    '                <div class="about">\n' +
                    '                    <div id="userNameAppender_' + users[i] + '" class="name">' + users[i] + '</div>\n' +
                    '                    <div class="status">\n' +
                    '                        <i class="fa fa-circle offline"></i>\n' +
                    '                    </div>\n' +
                    '                </div>\n' +
                    '            </li></a>';
            }
            $('#usersList').html(usersTemplateHTML);
        });
    }

</script>
</head>
<section>
    <div>
        <input type="hidden" id="username" th:value="${username}">
        <button id="startChat" onclick="registration()">채팅 시작</button>
        <div class="list_title_box">
            <h1 class="list_title">접속중인 사용자 조회</h1>
            <button id="refresh" onclick="fetchAll()">새로고침</button>
            <div class="list_devide"></div>
            <h3 class="list_notice">채팅 하고자 하는 회원을 선택하세요.</h3>
        </div>

        <div>
            <table class="list_table">
                <thead class="table_head">
                <tr>
                    <th>닉네임</th>
                </tr>
                </thead>
                <ul class="list" id="usersList">
                </ul>
            </table>
        </div>
    </div>
</section>
</html>